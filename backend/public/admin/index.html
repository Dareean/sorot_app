<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Sorot - Admin Dashboard</title>

  <!-- Charts & Leaflet -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:linear-gradient(135deg,#DEF2C8 0%,#C5DAC1 100%);color:#2C6E49;min-height:100vh}
    .login-container{display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px}
    .login-card{background:#fff;padding:40px;border-radius:20px;box-shadow:0 20px 40px rgba(44,110,73,.1);width:100%;max-width:400px}
    .login-header{text-align:center;margin-bottom:30px}
    .login-header h1{color:#2C6E49;font-size:28px;margin-bottom:10px}
    .login-header p{color:#A9B2AC;font-size:14px}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:8px;font-weight:500;color:#2C6E49}
    .form-control{width:100%;padding:12px 16px;border:2px solid #C5DAC1;border-radius:12px;font-size:14px;background:#DEF2C8;transition:border-color .3s}
    .form-control:focus{outline:none;border-color:#2C6E49}
    .btn-primary{width:100%;background:linear-gradient(45deg,#2C6E49,#1A4A32);color:#fff;border:none;padding:14px;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;transition:transform .2s}
    .btn-primary:hover{transform:translateY(-2px)}
    .alert{padding:12px;border-radius:8px;margin-bottom:20px;display:none}
    .alert-danger{background:#fff5f5;border:1px solid #fed7d7;color:#c53030}
    .dashboard{display:none;min-height:100vh}
    .navbar{background:#fff;padding:15px 30px;box-shadow:0 2px 10px rgba(44,110,73,.1);display:flex;justify-content:space-between;align-items:center}
    .navbar-brand{font-size:24px;font-weight:bold;color:#2C6E49}
    .navbar-user{display:flex;align-items:center;gap:15px}
    .user-info{color:#666;font-size:14px}
    .btn-logout{background:#F94144;color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:12px}
    .main-container{display:flex;min-height:calc(100vh - 80px)}
    .sidebar{width:260px;background:#fff;box-shadow:2px 0 10px rgba(44,110,73,.1);padding:30px 0}
    .sidebar-menu{list-style:none}
    .sidebar-menu li{margin:5px 0}
    .sidebar-menu a{display:flex;align-items:center;padding:15px 30px;color:#666;text-decoration:none;transition:.3s;gap:12px}
    .sidebar-menu a:hover,.sidebar-menu a.active{background:linear-gradient(90deg,#DEF2C8,transparent);color:#2C6E49;border-right:4px solid #2C6E49}
    .content{flex:1;padding:30px;overflow-x:auto}
    .page-header{margin-bottom:30px}
    .page-header h2{color:#2C6E49;font-size:28px;margin-bottom:8px}
    .page-header p{color:#A9B2AC;font-size:14px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:#fff;padding:25px;border-radius:16px;box-shadow:0 4px 20px rgba(44,110,73,.1);transition:.3s}
    .stat-card:hover{transform:translateY(-5px)}
    .stat-card-icon{width:60px;height:60px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:24px;margin-bottom:15px}
    .stat-card-value{font-size:32px;font-weight:bold;color:#2C6E49;margin-bottom:5px}
    .stat-card-label{color:#A9B2AC;font-size:14px;font-weight:500}
    .card{background:#fff;border-radius:16px;box-shadow:0 4px 20px rgba(44,110,73,.1);margin-bottom:20px}
    .card-header{padding:25px;border-bottom:1px solid #f0f0f0}
    .card-header h3{color:#2C6E49;font-size:20px;margin:0}
    .card-body{padding:25px}
    .table{width:100%;border-collapse:collapse;margin-top:20px}
    .table th,.table td{padding:15px;text-align:left;border-bottom:1px solid #f0f0f0}
    .table th{background:#DEF2C8;color:#2C6E49;font-weight:600;font-size:14px}
    .table td{font-size:14px;color:#666}
    .badge{padding:6px 12px;border-radius:20px;font-size:12px;font-weight:500;text-transform:uppercase}
    .badge-submitted{background:#FFF3CD;color:#856404}.badge-accepted{background:#D1F2EB;color:#0C5460}.badge-inProgress{background:#CCE5FF;color:#0066CC}.badge-completed{background:#D4EDDA;color:#155724}.badge-rejected{background:#F8D7DA;color:#721C24}
    .page{display:none}.page.active{display:block}
    #map{height:400px;border-radius:12px;margin-top:20px}
    .loading{display:flex;justify-content:center;align-items:center;padding:40px}
    .spinner{width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #2C6E49;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:768px){.main-container{flex-direction:column}.sidebar{width:100%;order:2}.content{order:1;padding:20px}.stats-grid{grid-template-columns:1fr}}
  </style>
</head>

<body>
  <!-- Login -->
  <div id="loginContainer" class="login-container">
    <div class="login-card">
      <div class="login-header">
        <h1>üå± Sorot Admin</h1>
        <p>Masuk ke dashboard admin untuk mengelola laporan</p>
      </div>
      <div id="loginAlert" class="alert alert-danger"></div>

      <form id="loginForm">
        <div class="form-group">
          <label for="username">Email</label>
          <input type="email" id="username" class="form-control" required />
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" class="form-control" required />
        </div>
        <button type="submit" class="btn-primary" id="loginBtn">Masuk ke Dashboard</button>
      </form>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="dashboard">
    <nav class="navbar">
      <div class="navbar-brand">üå± Sorot Dashboard</div>
      <div class="navbar-user">
        <div class="user-info">
          <span id="adminUsername"></span>
          <div style="font-size:11px;color:#999">Last login: <span id="lastLogin"></span></div>
        </div>
        <button class="btn-logout" id="logoutBtn">Logout</button>
      </div>
    </nav>

    <div class="main-container">
      <div class="sidebar">
        <ul class="sidebar-menu">
          <li><a href="#" class="active" data-page="overview">üìä Dashboard</a></li>
          <li><a href="#" data-page="reports">üìù Kelola Laporan</a></li>
          <li><a href="#" data-page="map">üó∫Ô∏è Peta Laporan</a></li>
          <li><a href="#" data-page="analytics">üìà Analytics</a></li>
        </ul>
      </div>

      <div class="content">
        <!-- Overview -->
        <div id="overviewPage" class="page active">
          <div class="page-header">
            <h2>Dashboard Overview</h2>
            <p>Monitor laporan lingkungan secara real-time</p>
          </div>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-card-icon" style="background:linear-gradient(45deg,#FFB703,#FF8500);color:#fff">üìä</div>
              <div class="stat-card-value" id="totalReports">-</div>
              <div class="stat-card-label">Total Laporan</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-icon" style="background:linear-gradient(45deg,#28a745,#20c997);color:#fff">üìÖ</div>
              <div class="stat-card-value" id="todayReports">-</div>
              <div class="stat-card-label">Laporan Hari Ini</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-icon" style="background:linear-gradient(45deg,#17a2b8,#138496);color:#fff">‚è≥</div>
              <div class="stat-card-value" id="pendingReports">-</div>
              <div class="stat-card-label">Menunggu Review</div>
            </div>
            <div class="stat-card">
              <div class="stat-card-icon" style="background:linear-gradient(45deg,#6f42c1,#5a32a3);color:#fff">‚úÖ</div>
              <div class="stat-card-value" id="completedReports">-</div>
              <div class="stat-card-label">Selesai Ditangani</div>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
            <div class="card">
              <div class="card-header"><h3>Status Laporan</h3></div>
              <div class="card-body"><canvas id="statusChart" height="300"></canvas></div>
            </div>
            <div class="card">
              <div class="card-header"><h3>Kategori Laporan</h3></div>
              <div class="card-body"><canvas id="categoryChart" height="300"></canvas></div>
            </div>
          </div>

          <div class="card">
            <div class="card-header"><h3>Laporan Terbaru</h3></div>
            <div class="card-body">
              <div class="table-container">
                <table class="table">
                  <thead>
                    <tr><th>Judul</th><th>Kategori</th><th>Lokasi</th><th>Status</th></tr>
                  </thead>
                  <tbody id="recentReportsBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Reports -->
        <div id="reportsPage" class="page">
          <div class="page-header">
            <h2>Kelola Laporan</h2>
            <p>Kelola & update status</p>
          </div>

          <div class="card">
            <div class="card-body">
              <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
                <select id="filterStatus" class="form-control" style="max-width:200px">
                  <option value="">Semua Status</option>
                  <option>Menunggu</option><option>Diterima</option><option>Diproses</option><option>Selesai</option><option>Ditolak</option>
                </select>
                <select id="filterCategory" class="form-control" style="max-width:220px">
                  <option value="">Semua Kategori</option>
                  <option>Sampah Ilegal</option><option>Polusi Air</option><option>Polusi Udara</option>
                  <option>Kerusakan Fasilitas</option><option>Illegal Dumping</option><option>Kerusuhan/Tawuran</option><option>Lainnya</option>
                </select>
                <input id="searchKeyword" class="form-control" placeholder="Cari judul/deskripsi..." style="max-width:240px" />
                <button class="btn-primary" style="width:auto;padding:10px 14px" id="btnRefreshReports">Refresh</button>
              </div>

              <div class="table-container">
                <table class="table">
                  <thead>
                    <tr>
                        <th>Foto</th><th>Judul</th><th>Kategori</th><th>Lokasi</th><th>Status</th><th>Catatan</th><th>Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="reportsTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Map -->
        <div id="mapPage" class="page">
          <div class="page-header"><h2>Peta Laporan</h2></div>
          <div class="card"><div class="card-body"><div id="map"></div></div></div>
        </div>

        <!-- Analytics -->
        <div id="analyticsPage" class="page">
          <div class="page-header"><h2>Analytics</h2></div>
          <div class="card"><div class="card-body"><canvas id="monthlyChart" height="400"></canvas></div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK (modular) -->
  <script type="module">
    // Firebase v10
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, collection, query, orderBy, limit, onSnapshot,
      doc, updateDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ====== CONFIG PROJECTMU ======
    const firebaseConfig = {
      apiKey: "AIzaSyClLa_Ps8PoCy9YU4IVvriOSlhfjJeKokM",
      authDomain: "sorot-app-13097.firebaseapp.com",
      projectId: "sorot-app-13097",
      storageBucket: "sorot-app-13097.firebasestorage.app",
      messagingSenderId: "647800295624",
      appId: "1:647800295624:web:a54a1d34dfc25aaf6f95fd",
      measurementId: "G-8G04BGKHW6"
    };

    if (getApps().length === 0) initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    // ====== DOM ======
    const $ = (s)=>document.querySelector(s);
    const loginContainer = $('#loginContainer');
    const dashboard = $('#dashboard');
    const loginForm = $('#loginForm');
    const loginAlert = $('#loginAlert');
    const adminUsername = $('#adminUsername');
    const lastLogin = $('#lastLogin');
    const logoutBtn = $('#logoutBtn');

    // Stats cards
    const elTotalReports = $('#totalReports');
    const elTodayReports = $('#todayReports');
    const elPendingReports = $('#pendingReports');
    const elCompletedReports = $('#completedReports');

    // Overview widgets
    const recentReportsBody = $('#recentReportsBody');
    const statusChartCanvas = $('#statusChart');
    const categoryChartCanvas = $('#categoryChart');

    // Reports controls
    const filterStatus = $('#filterStatus');
    const filterCategory = $('#filterCategory');
    const searchKeyword = $('#searchKeyword');
    const btnRefreshReports = $('#btnRefreshReports');
    const reportsTableBody = $('#reportsTableBody');

    // Map & Analytics
    const mapContainer = $('#map');
    const monthlyChartCanvas = $('#monthlyChart');

    // Sidebar navigation
    document.querySelectorAll('.sidebar-menu a').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        document.querySelectorAll('.sidebar-menu a').forEach(x=>x.classList.remove('active'));
        a.classList.add('active');
        const page = a.dataset.page;
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        const idMap = {overview:'overviewPage',reports:'reportsPage',map:'mapPage',analytics:'analyticsPage'};
        document.getElementById(idMap[page]).classList.add('active');
        if(page==='map') setTimeout(initMap, 100);
      });
    });

    // ====== Helpers ======
    const STATUS_MAP = {
      pending:'Menunggu', submitted:'Menunggu',
      accepted:'Diterima', inprogress:'Diproses',
      completed:'Selesai', rejected:'Ditolak',
      menunggu:'Menunggu', diterima:'Diterima',
      diproses:'Diproses', selesai:'Selesai', ditolak:'Ditolak'
    };
    const toIdStatus = (s)=> STATUS_MAP[(s||'').toString().toLowerCase()] || (s||'Menunggu');
    const toBadgeKey = (s)=>{
      const key = (s||'').toString().toLowerCase();
      if(['menunggu','pending','submitted'].includes(key)) return 'submitted';
      if(['diterima','accepted'].includes(key)) return 'accepted';
      if(['diproses','inprogress'].includes(key)) return 'inProgress';
      if(['selesai','completed'].includes(key)) return 'completed';
      if(['ditolak','rejected'].includes(key)) return 'rejected';
      return 'submitted';
    };

    const toReport = (d)=>{
      const r = d.data() || {};
      const loc = r.location || {};
      const lat = (typeof r.lat==='number') ? r.lat : (typeof loc.lat==='number') ? loc.lat : (loc._lat ?? null);
      const lng = (typeof r.lng==='number') ? r.lng : (typeof loc.lng==='number') ? loc.lng : (loc._long ?? null);
      return {
        id: d.id,
        title: r.title || '-',
        desc: (r.desc ?? r.description ?? '-'),
        category: r.category || '-',
        status: toIdStatus(r.status),
        rawStatus: (r.status ?? '').toString(),
        createdAt: r.createdAt?.toDate?.() ?? null,
        lat, lng,
        photoUrl: r.photoUrl || null,
        adminNote: r.adminNote || null,
      };
    };

    function escapeHtml(s){
      return (s??'').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // ====== State ======
    let allReports = [];
    let leafletMap, leafletMarkers;  
    let statusChart, categoryChart, monthlyChart;

    // ====== Auth ======
    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      loginAlert.style.display='none';
      const email = $('#username').value.trim();
      const pass  = $('#password').value.trim();
      try{
        await signInWithEmailAndPassword(auth, email, pass);
      }catch(err){
        loginAlert.textContent = `Login gagal: ${err.code || err.message || err}`;
        loginAlert.style.display='block';
      }
    });

    logoutBtn.addEventListener('click', async ()=>{
      try{ await signOut(auth); }catch{}
    });

    onAuthStateChanged(auth, (u)=>{
      if(u){
        loginContainer.style.display='none';
        dashboard.style.display='block';
        adminUsername.textContent = u.email || u.uid;
        try{
          const ts = (u.metadata?.lastSignInTime) ? new Date(u.metadata.lastSignInTime) : null;
          lastLogin.textContent = ts ? ts.toLocaleString() : '-';
        }catch{ lastLogin.textContent = '-'; }
      }else{
        dashboard.style.display='none';
        loginContainer.style.display='flex';
      }
    });

    // ====== Data stream ======
    const qLatest = query(collection(db,'reports'), orderBy('createdAt','desc'), limit(200));
    onSnapshot(qLatest, (snap)=>{
      allReports = snap.docs.map(toReport);

      // Stats cards
      elTotalReports.textContent = String(allReports.length);
      const now = new Date();
      const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      elTodayReports.textContent = String(allReports.filter(r => r.createdAt && r.createdAt >= start).length);
      elPendingReports.textContent = String(allReports.filter(r=>r.status==='Menunggu').length);
      elCompletedReports.textContent = String(allReports.filter(r=>r.status==='Selesai').length);

      // Recent (top 10)
      renderRecent(allReports.slice(0,10));

      // Charts
      renderCharts(allReports);

      // Reports table
      renderReportsTable();

      // Map
      refreshMapMarkers();
    });

    // ====== Overview: recent table ======
    function renderRecent(list){
      recentReportsBody.innerHTML='';
      list.forEach(r=>{
        const tr = document.createElement('tr');
        const badgeKey = toBadgeKey(r.rawStatus || r.status);
        tr.innerHTML = `
          <td>${escapeHtml(r.title)}</td>
          <td>${escapeHtml(r.category)}</td>
          <td>${(r.lat!=null && r.lng!=null) ? `${r.lat.toFixed(4)}, ${r.lng.toFixed(4)}` : '-'}</td>
          <td><span class="badge badge-${badgeKey}">${escapeHtml(r.status)}</span></td>
        `;
        recentReportsBody.appendChild(tr);
      });
    }

    // ====== Reports page ======
    function renderReportsTable(){
      const kw = (searchKeyword.value || '').toLowerCase().trim();
      const fs = (filterStatus.value || '').trim();
      const fc = (filterCategory.value || '').trim();

      const filtered = allReports.filter(r=>{
        const okS = fs ? (r.status === fs) : true;
        const okC = fc ? (r.category === fc) : true;
        const okK = kw ? ((r.title||'').toLowerCase().includes(kw) || (r.desc||'').toLowerCase().includes(kw)) : true;
        return okS && okC && okK;
      });

      reportsTableBody.innerHTML='';
      filtered.forEach(r=>{
        const tr = document.createElement('tr');
        const badgeKey = toBadgeKey(r.rawStatus || r.status);
        const statusSelectId = `sel-${r.id}`;
        const statusSelectHtml = `
          <select id="${statusSelectId}" class="form-control" style="max-width:200px">
            ${['Menunggu','Diterima','Diproses','Selesai','Ditolak'].map(opt =>
              `<option value="${opt}" ${opt===r.status?'selected':''}>${opt}</option>`).join('')}
          </select>
        `;

        tr.innerHTML = `
          <td>
            ${r.photoUrl
              ? `<a href="${r.photoUrl}" target="_blank" rel="noopener">
                   <img src="${r.photoUrl}" alt="foto" style="width:64px;height:64px;object-fit:cover;border-radius:8px;background:#bcd0c7"/>
                 </a>`
              : `<div style="width:64px;height:64px;border-radius:8px;background:#bcd0c7;display:flex;align-items:center;justify-content:center;color:#2C6E49">‚Äî</div>`}
          </td>
          <td>${escapeHtml(r.title)}</td>
          <td>${escapeHtml(r.category)}</td>
          <td>${(r.lat!=null && r.lng!=null) ? `${r.lat.toFixed(4)}, ${r.lng.toFixed(4)}` : '-'}</td>
          <td><span class="badge badge-${badgeKey}">${escapeHtml(r.status)}</span></td>
          <td title="${escapeHtml(r.adminNote ?? '')}">
             ${escapeHtml((r.adminNote ?? '-'))}
          </td>
          <td style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            ${statusSelectHtml}
            <button class="btn-primary" data-id="${r.id}" style="width:auto;padding:8px 12px">Simpan</button>
            <button class="btn-logout" data-del="${r.id}" style="width:auto;padding:8px 12px">Hapus</button>
            <button class="btn-primary" data-note="${r.id}" style="width:auto;padding:8px 12px;background:#5a32a3">Catatan</button>
          </td>
        `;

        reportsTableBody.appendChild(tr);

        // Handler Simpan
        const btn = tr.querySelector('button.btn-primary');
        const sel = tr.querySelector(`#${CSS.escape(statusSelectId)}`);
        btn.addEventListener('click', async ()=>{
          const newVal = sel.value; // 'Menunggu'|'Diterima'|'Diproses'|'Selesai'|'Ditolak'
          if (newVal === r.status) return;
          btn.disabled = true; btn.textContent = 'Menyimpan‚Ä¶';
          try {
            await updateDoc(doc(db, 'reports', r.id), { status: newVal });
            // Optimistic local update
            r.status = newVal;
            r.rawStatus = newVal;
            renderReportsTable();
          } catch (e) {
            alert(`Gagal mengubah status: ${e.code || e.message || e}`);
          } finally {
            btn.disabled = false; btn.textContent = 'Simpan';
          }
        });

        // Handler Hapus
        const delBtn = tr.querySelector('button[data-del]');
        delBtn.addEventListener('click', async ()=>{
          if (confirm('Yakin hapus laporan ini?')) {
            try {
              await deleteDoc(doc(db, 'reports', r.id));
            } catch (e) {
              alert(`Gagal menghapus: ${e.code || e.message || e}`);
            }
          }
        });

        // Handler tombol "Catatan"
        const noteBtn = tr.querySelector('button[data-note]');
        noteBtn.addEventListener('click', async ()=>{
          const cur = r.adminNote ?? '';
          const next = prompt('Catatan admin:', cur);
          if (next === null) return; // dibatalkan
          try {
            await updateDoc(doc(db, 'reports', r.id), { adminNote: next.trim() });
            r.adminNote = next.trim();  // optimistic update
            renderReportsTable();
          } catch (e) {
            alert(`Gagal menyimpan catatan: ${e.code || e.message || e}`);
          }
        });
      });
    }

    filterStatus.addEventListener('change', renderReportsTable);
    filterCategory.addEventListener('change', renderReportsTable);
    searchKeyword.addEventListener('input', renderReportsTable);
    btnRefreshReports.addEventListener('click', renderReportsTable);

    // ====== Charts ======
    function renderCharts(list){
      // Status
      const sMap = {};
      list.forEach(r=>{
        const s = toIdStatus(r.status);
        sMap[s]=(sMap[s]||0)+1;
      });
      const sLabels = Object.keys(sMap);
      const sData = sLabels.map(k=>sMap[k]);
      statusChart && statusChart.destroy();
      statusChart = new Chart(statusChartCanvas, {
        type:'doughnut',
        data:{ labels:sLabels, datasets:[{ data:sData }] },
        options:{ plugins:{ legend:{ position:'bottom' } } }
      });

      // Kategori
      const cMap = {};
      list.forEach(r=>{
        const c = r.category || '-';
        cMap[c]=(cMap[c]||0)+1;
      });
      const cLabels = Object.keys(cMap);
      const cData = cLabels.map(k=>cMap[k]);
      categoryChart && categoryChart.destroy();
      categoryChart = new Chart(categoryChartCanvas, {
        type:'bar',
        data:{ labels:cLabels, datasets:[{ data:cData }] },
        options:{ indexAxis:'y', plugins:{ legend:{ display:false } } }
      });

      // Analytics (per bulan, 12 bulan terakhir)
      const monthKey = (d)=> `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      const months = [];
      const now = new Date();
      for(let i=11;i>=0;i--){
        const t = new Date(now.getFullYear(), now.getMonth()-i, 1);
        months.push(monthKey(t));
      }
      const mMap = Object.fromEntries(months.map(m=>[m,0]));
      list.forEach(r=>{
        if(!r.createdAt) return;
        const m = monthKey(new Date(r.createdAt));
        if(m in mMap) mMap[m]++;
      });
      const mData = months.map(m=>mMap[m]);
      monthlyChart && monthlyChart.destroy();
      monthlyChart = new Chart(monthlyChartCanvas, {
        type:'line',
        data:{ labels:months, datasets:[{ data:mData, fill:false, tension:.2 }] },
        options:{ plugins:{ legend:{ display:false } } }
      });
    }

    // ====== Map (Leaflet) ======
    function initMap(){
      if (leafletMap) return;
      leafletMap = L.map(mapContainer).setView([-5.1477, 119.4327], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(leafletMap);
      leafletMarkers = L.layerGroup().addTo(leafletMap);
      refreshMapMarkers();
    }

    function refreshMapMarkers(){
      if (!leafletMarkers) return;
      leafletMarkers.clearLayers();
      const pts = [];
      allReports.forEach(r=>{
        if (r.lat!=null && r.lng!=null){
          const m = L.marker([r.lat, r.lng])
            .bindPopup(`<b>${escapeHtml(r.title)}</b><br>${escapeHtml(r.category)} ‚Ä¢ ${escapeHtml(r.status)}`);
          leafletMarkers.addLayer(m);
          pts.push([r.lat, r.lng]);
        }
      });
      if (pts.length){
        const bounds = L.latLngBounds(pts);
        leafletMap && leafletMap.fitBounds(bounds.pad(0.2));
      }
    }
  </script>
</body>
</html>
